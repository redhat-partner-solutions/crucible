- name: "Install node: {{inventory_hostname }}"
  delegate_to: bastion
  block:
    - name: "Wait for 20 min until {{ inventory_hostname }} discovered"
      uri:
        url: "{{ URL_ASSISTED_INSTALLER_CLUSTER }}"
        method: GET
        status_code: [200, 201]
        return_content: True
      register: cluster
      until: inventory_hostname in (cluster.json.hosts |  map(attribute='requested_hostname'))
      retries: 20
      delay: 60

    - name: "Wait for 20 min until {{ inventory_hostname }} to be ready"
      uri:
        url: "{{ URL_ASSISTED_INSTALLER_CLUSTER }}"
        method: GET
        status_code: [200, 201]
        return_content: True
      register: cluster
      until: (cluster.json.hosts | selectattr('requested_hostname', 'equalto', inventory_hostname) | map(attribute='status') | list)[0] in day2_states
      retries: 20
      delay: 60

    - name: Install cluster
      uri:
        url: "{{ URL_ASSISTED_INSTALLER_CLUSTER }}/actions/install_hosts"
        method: POST
        status_code: [202]
        return_content: True
        body_format: json
        body: {}
      register: http_reply
      when: (cluster.json.hosts | selectattr('requested_hostname', 'equalto', inventory_hostname) | map(attribute='status') | list)[0] == day2_host_found

    - import_role:
        name: monitor_host
      vars:
        ASSISTED_INSTALLER_BASE_URL: "{{ secure | ternary('https', 'http') }}://{{ hostvars['assisted_installer']['host'] }}:{{ hostvars['assisted_installer']['port'] }}/api/assisted-install/v1"
        CLUSTER_ID: "{{ add_host_cluster_id }}"
        waiting_termination_states:
          - "added-to-existing-cluster"
          - "installing-pending-user-action"
