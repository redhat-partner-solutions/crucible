---
- name: Populate Mirror with images required for installation
  become: true
  tags:
    - mirror_images
    - mirror_installation_images
  block:
    - name: Create podman auth dir
      ansible.builtin.file:
        path: "{{ config_file_path }}/containers/"
        state: directory
        mode: 0755

    - name: Copy pull_secrets file.
      ansible.builtin.copy:
        src: "{{ config_file_path }}/{{ pull_secret_file_name }}"
        dest: "{{ config_file_path }}/containers/auth.json"
        mode: 0644
        remote_src: true

    - name: Podman login to remote registry
      containers.podman.podman_login_info:
        registry: "registry.redhat.io"
      environment:
        XDG_RUNTIME_DIR: "{{ config_file_path }}"

    - name: Mirror remote ocpmetal image registry to local
      ansible.builtin.command:
        cmd: >
          /usr/local/bin/oc image mirror
            -a "{{ config_file_path }}/{{ pull_secret_file_name }}"
            {{ item.remote }}
            {{ item.local }}:{{ item.local_tag }}
      loop: "{{ ocpmetal_images }}"

    - name: Mirror release image to local (x86_64)
      ansible.builtin.command:
        cmd: >
          /usr/local/bin/oc adm release mirror
            -a "{{ config_file_path }}/{{ pull_secret_file_name }}"
            --from="{{ release_image_item.remote | quote }}"
            --to-release-image="{{ release_image_item.local | quote }}:{{ release_image_item.local_tag | quote }}"
            --to="{{ release_image_item.local | quote }}"

    - name: Mirror release image to local (arm64)
      ansible.builtin.command:
        cmd: >
          /usr/local/bin/oc adm release mirror
            -a "{{ config_file_path }}/{{ pull_secret_file_name }}"
            --from="{{ release_image_item_arm.remote | quote }}"
            --to-release-image="{{ release_image_item_arm.local | quote }}:{{ release_image_item_arm.local_tag | quote }}"
            --to="{{ release_image_item_arm.local | quote }}"
      when: arm_release_image_key in image_hashes

- name: Populate Mirror  with operators
  become: true
  tags:
    - mirror_images
    - mirror_operators
  when: populate_operator_catalog | bool
  block:
    - name: Build pruned OLM index
      ansible.builtin.command:
        cmd: >
          /usr/local/bin/opm index prune
            --from-index "{{ olm_index_item.remote }}"
            --packages "{{ mirror_packages | join(',') }}"
            --tag "{{ olm_index_item.local }}:{{ olm_index_item.local_tag }}"
      environment:
        XDG_RUNTIME_DIR: "{{ config_file_path }}"

    - name: Push pruned index to local registry
      ansible.builtin.command:
        cmd: >
          podman push
            --tls-verify=false
            {{ olm_index_item.local }}:{{ olm_index_item.local_tag }}
            --authfile "{{ config_file_path }}/{{ pull_secret_file_name }}"

    - name: Mirror Catalog to local registry
      ansible.builtin.command:
        cmd: >
          oc adm catalog mirror
            {{ olm_index_item.local }}:{{ olm_index_item.local_tag }}
            {{ olm_item.local }}:{{ olm_item.local_tag }}
            --registry-config="{{ config_file_path }}/{{ pull_secret_file_name }}"
